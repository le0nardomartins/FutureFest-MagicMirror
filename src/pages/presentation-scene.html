<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Apresentação - Uma Jornada no Nosso Tempo</title>
    <!-- Variáveis de ambiente para Vercel -->
    <meta name="OPENAI_API_KEY" content="">
    <meta name="ELEVENLABS_API_KEY" content="">
    <meta name="ELEVENLABS_VOICE_ID" content="">
    <meta name="EMAILJS_SERVICE_ID" content="">
    <meta name="EMAILJS_TEMPLATE_ID" content="">
    <meta name="EMAILJS_PUBLIC_KEY" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="../assets/favicon/site.webmanifest">
    <link rel="icon" href="../assets/favicon/favicon.ico">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="./styles/pages-styles.css">
    <style>
        /* Estilos específicos para a cena de apresentação */
        #sound-wave-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgb(0, 0, 0);
            z-index: 10;
            overflow: hidden;
        }
        
        #presentation-text {
            position: absolute;
            bottom: 20%;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            opacity: 0;
            transition: opacity 2s ease;
            text-shadow: 0 0 15px rgba(0, 200, 255, 0.8), 0 0 30px rgba(0, 255, 200, 0.4);
            z-index: 20;
        }
        
        .continue-button {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            background: transparent;
            color: white;
            border: 2px solid rgba(0, 230, 255, 0.7);
            border-radius: 30px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 1s ease, background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 20;
            box-shadow: 0 0 15px rgba(0, 200, 255, 0.4);
            text-shadow: 0 0 10px rgba(0, 255, 200, 0.7);
        }
        
        .continue-button:hover {
            background-color: rgba(0, 230, 255, 0.15);
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 0 20px rgba(0, 230, 255, 0.7), 0 0 30px rgba(0, 255, 200, 0.4);
        }
        .skip-btn { position:absolute; right: 18px; bottom: 18px; z-index: 30; }
        .debug-bar { position:absolute; left: 18px; bottom: 18px; z-index:30; display:flex; gap:8px; align-items:center; }
        .debug-bar input { padding: 8px 10px; border-radius:10px; border:1px solid rgba(0,255,220,0.35); background: rgba(0,0,0,0.35); color:#fff; width:min(340px, 40vw); }
        .btn { padding: 8px 12px; border-radius:10px; border:1px solid rgba(0,255,220,0.5); background: rgba(0,0,0,0.35); color:#fff; cursor:pointer; }
        .btn:hover { background: rgba(0,255,220,0.12); }
        #dev-switch { position:fixed; left:12px; top:12px; z-index:40; padding:6px 10px; border-radius:10px; border:1px solid rgba(0,255,220,0.5); background: rgba(0,0,0,0.35); color:#fff; cursor:pointer; }
    </style>
</head>
<body>
    <!-- Elementos do cursor personalizado -->
    <div class="cursor"></div>
    <div class="cursor-trail"></div>

    <!-- Elemento de áudio para a narração -->
    <audio id="presentation-audio" preload="auto">
        <source src="../assets/audio/voices/presentation.wav" type="audio/wav">
        Seu navegador não suporta o elemento de áudio.
    </audio>
    
    <!-- Elementos de áudio para os sons dos botões -->
    <audio id="hover-sound" preload="auto">
        <source src="../assets/audio/hover.wav" type="audio/wav">
    </audio>
    <audio id="click-sound" preload="auto">
        <source src="../assets/audio/clicked.wav" type="audio/wav">
    </audio>

    <div id="game-container">
        <div id="sound-wave-container">
            <!-- O canvas do círculo pulsante será inserido aqui pelo JavaScript -->
        </div>
        
        <div id="presentation-text">
            Bem-vindo à nossa jornada através do tempo
        </div>
        
        <button id="continue-button" class="continue-button" style="display: none;">
            Iniciar jornada
        </button>
        <button id="btn-skip-to-ai" class="btn skip-btn" data-dev-only>Â Pular apresentação</button>
        <div class="debug-bar" data-dev-only>
            <input id="dbg-text" placeholder="Digite um prompt para teste" />
            <button id="dbg-send-image" class="btn">Testar gerar/enviar imagem</button>
            <button id="dbg-final-context" class="btn">Simular encerramento</button>
            <button id="dbg-test-emailjs" class="btn">Testar EmailJS</button>
        </div>
        <button id="dev-switch">Dev: OFF</button>
    </div>

    <script src="../cursor-effects.js"></script>
    <script>
        // Preenche as meta tags com as variáveis de ambiente da Vercel (igual na ai-entity)
        (async function() {
            const envVars = [
                'OPENAI_API_KEY',
                'ELEVENLABS_API_KEY', 
                'ELEVENLABS_VOICE_ID',
                'EMAILJS_SERVICE_ID',
                'EMAILJS_TEMPLATE_ID',
                'EMAILJS_PUBLIC_KEY'
            ];
            try {
                const response = await fetch('/api/env');
                if (response.ok) {
                    const envData = await response.json();
                    envVars.forEach(key => {
                        const meta = document.querySelector(`meta[name="${key}"]`);
                        if (meta && envData[key]) meta.setAttribute('content', envData[key]);
                    });
                }
            } catch (error) { console.error('[env] erro ao carregar env na apresentação:', error); }
        })();
    </script>
    <!-- SDK oficial do EmailJS (necessário para window.emailjs) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="../sound-wave-animation.js"></script>
    <script src="../services/emailjs.js"></script>
    <script src="../services/dalle.js"></script>
    <script src="../game.js"></script>
    <script>
        // Inicialização protegida contra loops e sem recarregar ao continuar
        document.addEventListener('DOMContentLoaded', function() {
            if (window.__presentationInitialized) return;
            window.__presentationInitialized = true;

            const soundWave = new SoundWaveAnimation('sound-wave-container');
            const audioElement = document.getElementById('presentation-audio');
            const presentationText = document.getElementById('presentation-text');
            const continueButton = document.getElementById('continue-button');
            const hoverSound = document.getElementById('hover-sound');
            const clickSound = document.getElementById('click-sound');
            const btnSkipToAI = document.getElementById('btn-skip-to-ai');
            const dbgInput = document.getElementById('dbg-text');
            const dbgSend = document.getElementById('dbg-send-image');
            const dbgFinal = document.getElementById('dbg-final-context');
            const dbgTestEmail = document.getElementById('dbg-test-emailjs');
            const devSwitch = document.getElementById('dev-switch');

            soundWave.connectAudio('presentation-audio');

            setTimeout(() => {
                try { soundWave.playAudio(); } catch {}
                setTimeout(() => { presentationText.style.opacity = '1'; }, 2000);
                audioElement.onended = function() {
                    continueButton.style.display = 'block';
                    setTimeout(() => { continueButton.style.opacity = '1'; }, 100);
                };
            }, 500);

            const showEmailOverlay = () => {
                try { audioElement.pause(); } catch {}
                soundWave.stop();
                presentationText.style.opacity = '0';
                continueButton.style.display = 'none';

                // Fade para preto sobre toda a tela
                const fade = document.createElement('div');
                fade.id = 'fade-overlay';
                fade.style.position = 'absolute';
                fade.style.inset = '0';
                fade.style.background = 'black';
                fade.style.opacity = '0';
                fade.style.transition = 'opacity 800ms ease';
                fade.style.zIndex = '25';
                document.getElementById('game-container').appendChild(fade);
                // força reflow e anima
                requestAnimationFrame(() => { fade.style.opacity = '1'; });

                const buildCard = () => {
                    const overlay = document.createElement('div');
                    overlay.style.position = 'absolute';
                    overlay.style.inset = '0';
                    overlay.style.display = 'flex';
                    overlay.style.alignItems = 'center';
                    overlay.style.justifyContent = 'center';
                    overlay.style.zIndex = '30';
                    overlay.innerHTML = `
                      <div style="width:min(560px,92vw);background:rgba(6,20,24,0.72);border:1px solid rgba(0,230,255,0.28);border-radius:18px;padding:26px;color:#fff;font-family:Outfit,sans-serif;box-shadow:0 0 30px rgba(0,230,255,0.25), inset 0 0 20px rgba(0,255,220,0.06)">
                        <div style=\"font-size:26px;margin:0 0 10px;text-align:center;text-shadow:0 0 12px rgba(0,255,220,0.35)\">Antes de começarmos...</div>
                        <div style=\"font-size:16px;opacity:.9;text-align:center;margin-bottom:14px\">Deixe seu email para receber o resultado final. Se preferir, você pode pular.</div>
                        <div style=\"display:flex;gap:12px;margin-top:10px\">
                          <input id=\"email-input-inline\" type=\"email\" placeholder=\"seu@email.com\" style=\"flex:1;padding:14px 16px;border-radius:12px;border:1px solid rgba(0,230,255,0.35);background:rgba(0,10,12,0.5);color:#fff;box-shadow:inset 0 0 10px rgba(0,255,220,0.08)\"/>
                          <button id=\"btn-start-inline\" style=\"padding:12px 18px;border-radius:14px;border:1px solid rgba(0,230,255,0.55);background:linear-gradient(180deg, rgba(0,230,255,0.12), rgba(0,230,255,0.06));color:#fff;cursor:pointer;box-shadow:0 0 18px rgba(0, 200, 255, 0.25)\">Iniciar</button>
                          <button id=\"btn-skip-inline\" style=\"padding:12px 18px;border-radius:14px;border:1px solid rgba(0,230,255,0.55);background:linear-gradient(180deg, rgba(0,230,255,0.12), rgba(0,230,255,0.06));color:#fff;cursor:pointer;box-shadow:0 0 18px rgba(0, 200, 255, 0.25)\">Pular</button>
                        </div>
                        <div style=\"font-size:12px;opacity:.8;text-align:center;margin-top:10px\">A jornada seguirá normalmente mesmo sem email.</div>
                      </div>`;
                    document.getElementById('game-container').appendChild(overlay);

                    const hoverOn = (el) => {
                        el.style.backgroundImage = 'linear-gradient(180deg, rgba(0,230,255,0.2), rgba(0,230,255,0.12))';
                        el.style.transform = 'translateY(-1px)';
                        el.style.boxShadow = '0 0 24px rgba(0, 230, 255, 0.8), 0 0 36px rgba(0, 255, 200, 0.4)';
                    };
                    const hoverOff = (el) => {
                        el.style.backgroundImage = 'linear-gradient(180deg, rgba(0,230,255,0.12), rgba(0,230,255,0.06))';
                        el.style.transform = 'translateY(0)';
                        el.style.boxShadow = '0 0 18px rgba(0, 200, 255, 0.25)';
                    };

                    const goNext = (email) => {
                      const params = new URLSearchParams();
                      if ((email || '').trim()) params.set('email', email.trim());
                      window.location.href = 'ai-entity.html' + (params.toString() ? ('?' + params.toString()) : '');
                    };

                    const btnStart = document.getElementById('btn-start-inline');
                    const btnSkip = document.getElementById('btn-skip-inline');
                    const emailInput = document.getElementById('email-input-inline');

                    btnStart.addEventListener('mouseenter', function() {
                        hoverSound.currentTime = 0; hoverSound.play().catch(() => {});
                        hoverOn(btnStart);
                    });
                    btnStart.addEventListener('mouseleave', function() { hoverOff(btnStart); });
                    btnSkip.addEventListener('mouseenter', function() {
                        hoverSound.currentTime = 0; hoverSound.play().catch(() => {});
                        hoverOn(btnSkip);
                    });
                    btnSkip.addEventListener('mouseleave', function() { hoverOff(btnSkip); });

                    btnStart.addEventListener('click', function() {
                        clickSound.currentTime = 0; clickSound.play().catch(() => {});
                        goNext(emailInput.value);
                    });
                    btnSkip.addEventListener('click', function() {
                        clickSound.currentTime = 0; clickSound.play().catch(() => {});
                        goNext('');
                    });
                };

                fade.addEventListener('transitionend', buildCard, { once: true });
            };

            continueButton.addEventListener('click', function() {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
                showEmailOverlay();
            });
            continueButton.addEventListener('mouseenter', function() {
                hoverSound.currentTime = 0;
                hoverSound.play().catch(() => {});
            });
            // Novo: pular apresentação direto para AI Entity
            btnSkipToAI.addEventListener('click', function() {
                try { clickSound.currentTime = 0; clickSound.play().catch(() => {}); } catch {}
                soundWave.stop();
                window.location.href = 'ai-entity.html';
            });

            // Debug: testar geração e envio de imagem por email (fixo ou email via URL)
            dbgSend.addEventListener('click', async function() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const email = 'leonardomartins140124@gmail.com';
                    const narration = dbgInput.value || 'Mundo abandonado por desastres climáticos; cidades vazias, migrações em massa e ecossistemas colapsados.';
                    const mockStages = [
                        { narration },
                        { narration: 'n/a' },{ narration: 'n/a' },{ narration: 'n/a' },{ narration: 'n/a' },{ narration: 'n/a' },{ narration: 'n/a' },{ narration: 'n/a' }
                    ];
                    const dataUrl = await generateFinalWorldImage(mockStages);
                    if (email) {
                        const { url } = await renderKenBurnsVideoFromImage(dataUrl, { durationMs: 3000, fps: 30 });
                        console.log('Vídeo teste gerado:', url);
                        if (window.emailjsSendImage) {
                            try {
                                await window.emailjsSendImage({ to: email, imageDataUrl: dataUrl });
                                alert('Imagem enviada por email (teste).');
                            } catch (e) {
                                alert('Falha no envio por EmailJS: ' + (e && e.text ? e.text : (e && e.message ? e.message : 'erro desconhecido')));
                            }
                        } else {
                            alert('EmailJS não configurado. Apenas gerada a imagem.');
                        }
                    } else {
                        alert('Sem email. Gerei apenas a imagem para debug.');
                    }
                } catch (e) { console.error(e); alert('Falha no teste de imagem: ' + e.message); }
            });

            // Debug: simular contexto final (encerramento) sem passar pelos estágios
            dbgFinal.addEventListener('click', async function() {
                try {
                    const userFinal = dbgInput.value || 'Encerramento: sociedade adaptada a eventos climáticos extremos; biodiversidade reduzida; tecnologia de captura de carbono em larga escala; qualidade de vida desigual.';
                    const fakeHistory = Array.from({ length: 7 }).map((_, i) => ({ estagio: i+1, pergunta: '...', resposta_usuario: 'não sei', narracao: '...' }));
                    const worldStages = [...fakeHistory, { estagio: 8, pergunta: null, resposta_usuario: userFinal, narracao: '' }];
                    const messages = [
                        { role: 'system', content: 'Você é o narrador de encerramento. Responda em PT-BR com texto puro, sem perguntas, sem listas e sem travessões. O texto deve começar exatamente com: "Você fez suas escolhas viajante, e então chegamos ao fim..." e seguir descrevendo cultura, vida, ambiente, clima e como a humanidade sobreviveu ou não. Use apenas ponto final e vírgulas (sem ponto e vírgula). Máximo de 3 a 4 frases curtas. Mantenha tom poético e feche com uma reflexão sutil, sem ponto de interrogação. Se o desfecho for ruim, declare que o viajante repetiu os caminhos dos antepassados, fez as mesmas escolhas e se isentou da culpa, antes de descrever o estado final.' },
                        { role: 'user', content: `Considere que os estágios 1..7 tiveram respostas "não sei". No estágio 8, a última resposta do usuário foi: ${userFinal}. Gere um encerramento coeso seguindo as regras.` }
                    ];
                    // Usa a mesma chave já carregada
                    const headers = await (async () => {
                        const key = (window.__getEnvVar && window.__getEnvVar('OPENAI_API_KEY')) || '';
                        return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
                    })();
                    const resp = await fetch('https://api.openai.com/v1/chat/completions', { method:'POST', headers, body: JSON.stringify({ model: 'gpt-4o-mini', messages, temperature: 0.6 }) });
                    if (!resp.ok) { const err = await resp.text(); throw new Error(err); }
                    const data = await resp.json();
                    const content = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || '';
                    alert('Encerramento simulado:\n\n' + content.trim());
                } catch (e) { console.error(e); }
            });

            // Debug: testar se EmailJS está carregado e se envs existem
            dbgTestEmail.addEventListener('click', () => {
                const loaded = !!window.emailjs;
                const serviceId = (window.__getEnvVar && window.__getEnvVar('EMAILJS_SERVICE_ID')) || '';
                const templateId = (window.__getEnvVar && window.__getEnvVar('EMAILJS_TEMPLATE_ID')) || '';
                const publicKey = (window.__getEnvVar && window.__getEnvVar('EMAILJS_PUBLIC_KEY')) || '';
                let msg = loaded ? 'EmailJS SDK: carregado\n' : 'EmailJS SDK: NÃO carregado\n';
                msg += `SERVICE_ID: ${serviceId ? 'ok' : 'faltando'}\n`;
                msg += `TEMPLATE_ID: ${templateId ? 'ok' : 'faltando'}\n`;
                msg += `PUBLIC_KEY: ${publicKey ? 'ok' : 'faltando'}\n`;
                try {
                    if (loaded && publicKey) {
                        window.emailjs.init(publicKey);
                        msg += 'Init: sucesso';
                    }
                } catch (e) {
                    msg += `Init: falhou (${e && e.message})`;
                }
                alert(msg);
            });

            // Dev switch: mostra/oculta elementos com data-dev-only
            const applyDevVisibility = () => {
                const on = localStorage.getItem('dev_mode') === '1';
                devSwitch.textContent = on ? 'Dev: ON' : 'Dev: OFF';
                document.querySelectorAll('[data-dev-only]').forEach(el => {
                    el.style.display = on ? '' : 'none';
                });
            };
            devSwitch.addEventListener('click', () => {
                const on = localStorage.getItem('dev_mode') === '1';
                localStorage.setItem('dev_mode', on ? '0' : '1');
                applyDevVisibility();
            });
            applyDevVisibility();
        });
    </script>
</body>
</html> 
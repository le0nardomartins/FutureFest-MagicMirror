<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Entidade AI</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="../assets/favicon/site.webmanifest">
    <link rel="icon" href="../assets/favicon/favicon.ico">
    
    <!-- Variáveis de ambiente para Vercel -->
    <meta name="OPENAI_API_KEY" content="">
    <meta name="ELEVENLABS_API_KEY" content="">
    <meta name="ELEVENLABS_VOICE_ID" content="">
    <meta name="EMAILJS_SERVICE_ID" content="">
    <meta name="EMAILJS_TEMPLATE_ID" content="">
    <meta name="EMAILJS_PUBLIC_KEY" content="">
    <meta name="CLOUD_NAME" content="">
    <meta name="API_KEY" content="">
    <meta name="API_SECRET" content="">
    <meta name="CLOUDINARY_URL" content="">
    <meta name="CLOUDINARY_UPLOAD_PRESET" content="">
    
    <script>
        // Preenche as meta tags com as variáveis de ambiente da Vercel
        (async function() {
            const envVars = [
                'OPENAI_API_KEY',
                'ELEVENLABS_API_KEY', 
                'ELEVENLABS_VOICE_ID',
                'EMAILJS_SERVICE_ID',
                'EMAILJS_TEMPLATE_ID',
                'EMAILJS_PUBLIC_KEY',
                'CLOUD_NAME',
                'API_KEY',
                'API_SECRET',
                'CLOUDINARY_URL',
                'CLOUDINARY_UPLOAD_PRESET'
            ];
            
            try {
                // Busca as variáveis da API da Vercel
                const response = await fetch('/api/env');
                if (response.ok) {
                    const envData = await response.json();
                    console.log('[env] Variáveis carregadas da Vercel:', envData);
                    
                    envVars.forEach(key => {
                        const meta = document.querySelector(`meta[name="${key}"]`);
                        if (meta && envData[key]) {
                            meta.setAttribute('content', envData[key]);
                            console.log(`[env] ${key} carregada:`, envData[key].slice(0, 20) + '...');
                        } else {
                            console.warn(`[env] ${key} não encontrada na Vercel`);
                        }
                    });
                } else {
                    console.error('[env] Erro ao carregar variáveis da Vercel:', response.status);
                }
            } catch (error) {
                console.error('[env] Erro ao carregar variáveis da Vercel:', error);
            }
        })();
    </script>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="./styles/pages-styles.css">
    <style>
        #sound-wave-container { position:absolute; inset:0; background:#000; z-index: 1; }
        .overlay { position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; padding: 24px; z-index: 2; }
        .bubble { max-width: min(900px, 90vw); width: 100%; background: rgba(0,0,0,0.55); border:1px solid rgba(0,255,220,0.25); border-radius:16px; padding:18px; color:#fff; font-family:'Outfit', sans-serif; box-shadow:0 0 25px rgba(0,255,220,0.18); }
        .row { display:flex; gap:10px; align-items:center; }
        .label { font-size:12px; opacity:0.85; margin-bottom:6px; }
        .q { color:#A0FFF0; }
        .n { color:#FFDCA8; }
        .controls { position:absolute; top:12px; right:12px; z-index:3; display:flex; gap:8px; }
        .btn { padding: 8px 12px; border-radius:10px; border:1px solid rgba(0,255,220,0.5); background: rgba(0,0,0,0.35); color:#fff; cursor:pointer; }
        .btn:hover { background: rgba(0,255,220,0.12); }
        .loading { position:absolute; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; flex-direction:column; gap:16px; color:#fff; z-index:5; }
        .loading.show { display:flex; }
        video, img { max-width: 60vw; max-height: 50vh; border: 1px solid rgba(0,255,220,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="sound-wave-container"></div>
        <div class="controls">
            <button id="btn-fullscreen" class="btn">Tela cheia</button>
            <button id="btn-exit" class="btn">Encerrar</button>
        </div>
        <div class="overlay">
            <div class="bubble">
                <div class="label">Entidade AI</div>
                <div id="ai-question" class="q">Preparando pergunta...</div>
                <div id="ai-narration" class="n" style="margin-top:6px">Aguardando...</div>
            </div>
        </div>
        <div id="loading" class="loading">
            <div>Gerando imagem e vídeo do seu mundo...</div>
            <div id="progress">Preparando...</div>
            <div id="results" style="display:none; text-align:center">
                <div style="margin:8px 0">Imagem final</div>
                <img id="result-image" />
                <div style="margin:12px 0">Vídeo (prévia)</div>
                <video id="result-video" controls></video>
            </div>
            <button id="btn-finish" class="btn" style="display:none">Concluir</button>
        </div>
    </div>

    <script src="../sound-wave-animation.js"></script>
    <script>
        // Teste imediato de disponibilidade das variáveis
        console.log('[ai-entity] Teste imediato:');
    </script>
    <script src="../services/chat-web.js"></script>
    <script src="../services/emailjs.js"></script>
    <script src="../services/dalle.js"></script>
    <script>
        console.log('[ai-entity] Iniciando script...');
        // Gate de readiness: aguarda variáveis essenciais antes de iniciar
        window.__getEnvVar = window.__getEnvVar || function(key){
            const meta = document.querySelector(`meta[name="${key}"]`);
            return meta && meta.getAttribute('content') || '';
        };
        const waitEnvReady = async (keys, to=5000) => {
            const start = Date.now();
            while (Date.now() - start < to) {
                if (keys.every(k => (window.__getEnvVar(k) || '').trim())) return true;
                await new Promise(r => setTimeout(r, 100));
            }
            return false;
        };
        const required = ['OPENAI_API_KEY','ELEVENLABS_API_KEY','ELEVENLABS_VOICE_ID'];
        (async () => {
            const ready = await waitEnvReady(required, 5000);
            if (!ready) {
                console.error('[ai-entity] ❌ Variáveis obrigatórias não carregaram a tempo:', required);
                return;
            }
        
        const params = new URLSearchParams(window.location.search);
        const email = params.get('email') || '';
        console.log('[ai-entity] Email:', email);

        console.log('[ai-entity] Criando SoundWaveAnimation...');
        const soundWave = new SoundWaveAnimation('sound-wave-container');
        console.log('[ai-entity] SoundWaveAnimation criada:', soundWave);
        const $q = document.getElementById('ai-question');
        const $n = document.getElementById('ai-narration');
        const $loading = document.getElementById('loading');
        const $progress = document.getElementById('progress');
        const $results = document.getElementById('results');
        const $img = document.getElementById('result-image');
        const $video = document.getElementById('result-video');
        const $btnFinish = document.getElementById('btn-finish');

        let lastWorldStages = [];

        const chat = createAIEntityChat({
            email,
            onTranscript: (txt) => {},
            onAIQuestion: (q) => { $q.textContent = q; },
            onAINarration: (n) => { $n.textContent = n; },
            onWorldUpdate: ({ worldStages }) => { lastWorldStages = worldStages; },
            onFinish: async (worldStages) => {
                // Gera imagem/vídeo e envia email APENAS se houver email
                const params = new URLSearchParams(window.location.search);
                const emailParam = (params.get('email') || '').trim();
                if (!emailParam) { return; }
                $loading.classList.add('show');
                $progress.textContent = 'Gerando imagem...';
                try {
                    const imageDataUrl = await generateFinalWorldImage(worldStages);
                    $img.src = imageDataUrl;
                    $progress.textContent = 'Gerando vídeo...';
                    const { url } = await renderKenBurnsVideoFromImage(imageDataUrl, { durationMs: 10000, fps: 30 });
                    $video.src = url;
                    $results.style.display = 'block';
                    $progress.textContent = 'Concluído!';
                    $btnFinish.style.display = 'inline-block';
                    try {
                        if (window.emailjsSendImage) {
                            await window.emailjsSendImage({ to: emailParam, imageDataUrl });
                        }
                    } catch (e) { console.error('email send error:', e); }
                } catch (err) {
                    console.error(err);
                    $progress.textContent = 'Falha ao gerar imagem/vídeo.';
                    $btnFinish.style.display = 'inline-block';
                }
            },
            onDebug: null
        });

        document.getElementById('btn-exit').addEventListener('click', () => {
            soundWave.stop();
            window.location.href = 'presentation-scene.html';
        });

        // Alternância de tela cheia
        const $btnFs = document.getElementById('btn-fullscreen');
        const rootEl = document.documentElement;
        const isFullscreen = () => !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
        const reqFS = async () => {
            try {
                if (rootEl.requestFullscreen) return await rootEl.requestFullscreen();
                if (rootEl.webkitRequestFullscreen) return await rootEl.webkitRequestFullscreen();
                if (rootEl.msRequestFullscreen) return await rootEl.msRequestFullscreen();
            } catch {}
        };
        const exitFS = async () => {
            try {
                if (document.exitFullscreen) return await document.exitFullscreen();
                if (document.webkitExitFullscreen) return await document.webkitExitFullscreen();
                if (document.msExitFullscreen) return await document.msExitFullscreen();
            } catch {}
        };
        const updateFsButton = () => { $btnFs.textContent = isFullscreen() ? 'Sair da tela cheia' : 'Tela cheia'; };
        document.addEventListener('fullscreenchange', updateFsButton);
        document.addEventListener('webkitfullscreenchange', updateFsButton);
        document.addEventListener('msfullscreenchange', updateFsButton);
        updateFsButton();
        $btnFs.addEventListener('click', async () => {
            if (isFullscreen()) await exitFS(); else await reqFS();
            updateFsButton();
        });

        $btnFinish.addEventListener('click', () => {
            $loading.classList.remove('show');
        });

        // Start loop
        console.log('[ai-entity] Iniciando chat...');
        chat.start();
        console.log('[ai-entity] Chat iniciado!');
        })();
    </script>
</body>
</html>


